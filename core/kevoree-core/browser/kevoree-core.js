!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("KevoreeLibrary")):"function"==typeof define&&define.amd?define(["KevoreeLibrary"],t):"object"==typeof exports?exports.KevoreeCore=t(require("KevoreeLibrary")):e.KevoreeCore=t(e.KevoreeLibrary)}(this,function(e){return function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,r){"use strict";function n(e,t,r){if(!e||!t||!r)throw new Error("KevoreeCore constructor needs: Resolver, KevScript engine and a LoggerFactory");this.resolver=e,this.loggerFactory=r,this.log=r.create("Core"),this.kevs=t,this.stopping=!1,this.currentModel=null,this.deployModel=null,this.nodeName=null,this.nodeInstance=null,this.firstBoot=!0,this.scriptQueue=[],this.emitter=new u}function o(e){var t=0;if(0===e.length)return t+"";for(var r=0;r<e.length;r++){t=(t<<5)-t+e.charCodeAt(r),t&=t}return(268435455&t)+""}function i(e){return o((e.hub?e.hub.path():"UNDEFINED")+"_"+(e.port?e.port.path():"UNDEFINED"))}function s(e){e.mBindings.array.forEach(function(e){e.generated_KMF_ID=i(e)})}var a=r(1),u=r(2).EventEmitter,c=r(3),l=/^[\w]+$/;n.prototype={start:function(e){if(e&&0!==e.length||(e="node0"),!e.match(l))throw new Error("Platform node name must match this regex "+l.toString());this.nodeName=e;var t=new a.factory.DefaultKevoreeFactory;this.currentModel=t.createContainerRoot(),t.root(this.currentModel);var r=t.createContainerNode();r.name=this.nodeName,r.started=!1,this.currentModel.addNodes(r),this.loopId=setInterval(function(){},1e11),this.log.info("Platform node name: "+e)},stop:function(){var e=this,t=new a.factory.DefaultKevoreeFactory,r=t.createModelCloner(),n=r.clone(this.currentModel,!1),o=n.findNodesByID(this.nodeName);if(o.started){o.started=!1;for(var i=o.hosts.iterator();i.hasNext();)i.next().delete();for(var s=o.groups.iterator();s.hasNext();)s.next().delete();for(var u=n.mBindings.iterator();u.hasNext();){var c=u.next();c.port.eContainer()&&c.port.eContainer().eContainer()&&c.port.eContainer().eContainer().name===o.name&&c.hub&&c.hub.delete()}for(var l=o.components.iterator();l.hasNext();)l.next().delete();return this.stopping=!0,this.deploy(n).then(function(){null===e.nodeInstance?(e.log.info("Platform stopped before bootstrapped",{tag:e.toString()}),e.emitter.emit("stopped")):(e.log.info("Platform stopped: "+e.nodeInstance.getName(),{tag:e.toString()}),clearInterval(e.loopId))})}return Promise.resolve()},deploy:function(e){var t=this;return new Promise(function(r,n){t.deployModel?(t.log.warn("New deploy process requested: aborted because another one is in process (retry later?)"),n(new Error("New deploy process requested: aborted because another one is in process (retry later?)"))):(t.emitter.emit("deploying",e),e&&!e.findNodesByID(t.nodeName)?n(new Error("Deploy model failure: unable to find "+t.nodeName+" in given model")):(t.log.debug((t.stopping?"Stopping":"Deploy")+" process started..."),e?t.checkBootstrapNode(e).then(function(){if(t.nodeInstance){var o=void 0;try{s(e);var i=new a.factory.DefaultKevoreeFactory,u=i.createModelCloner();t.deployModel=u.clone(e,!0),t.deployModel.setRecursiveReadOnly();var l=i.createModelCompare().diff(t.currentModel,t.deployModel);o=t.nodeInstance.processTraces(l,t.deployModel),c(t,e,o,r,n)}catch(e){t.log.error(e.stack);var h=new Error("Something went wrong while creating adaptations (deployment ignored)");t.log.warn(h.message),t.deployModel=null,t.firstBoot?(t.log.warn("Shutting down Kevoree because bootstrap failed..."),n(h),t.emitter.emit("error",h)):(n(h),t.emitter.emit("error",h))}}else n(new Error("There is no instance to bootstrap on"))}).catch(function(e){t.emitter.emit("error",e),n(e)}):n(new Error("Model is not defined or null. Deploy aborted."))))})},submitScript:function(e){var t=this;if(null===this.deployModel)return this.kevs.parse(e,this.currentModel).then(function(e){var r=e.model;return t.deploy(r)}).then(function(){t.log.info("KevScript submission succeeded")}).catch(function(e){throw t.log.warn("KevScript submission threw an error"),t.log.warn(e.stack),e});var r=Promise.resolve();return this.scriptQueue.push({script:e,promise:r}),this.log.debug("Script added to queue at position "+this.scriptQueue.length-1),r},processScriptQueue:function(){var e=this;if(this.scriptQueue.length>0){var t=this.scriptQueue[0];this.scriptQueue.splice(0,1),this.log.debug("Core.processScriptQueue parsing "+t.script),t.promise.then(function(){return e.submitScript(t.script)})}},checkBootstrapNode:function(e){var t=this;return new Promise(function(r,n){if(t.nodeInstance)r();else{t.log.debug("Start '"+t.nodeName+"' bootstrapping...");var o=e.findNodesByID(t.nodeName);if(o){var i=o.typeDefinition.select("deployUnits[]/filters[name=platform,value=js]");i.size()>0?t.resolver.resolve(i.get(0).eContainer(),!1,function(o,i){if(o)n(o);else try{var s=e.findNodesByID(t.nodeName),u=t.currentModel.findNodesByID(t.nodeName);t.nodeInstance=new i(t,s,t.nodeName);var c=new a.factory.DefaultKevoreeFactory;u.dictionary=c.createDictionary().withGenerated_KMF_ID("0"),s.typeDefinition.dictionaryType&&s.typeDefinition.dictionaryType.attributes.array.forEach(function(e){if(!e.fragmentDependant){var r=c.createValue();r.name=e.name;s.dictionary.findValuesByID(r.name)||(r.value=e.defaultValue,u.dictionary.addValues(r),t.log.debug("Set default node param: "+r.name+"="+r.value))}}),r()}catch(o){n(o)}}):n(new Error("No DeployUnit found for '"+t.nodeName+"' that matches the 'js' platform"))}else n(new Error("Unable to find '"+t.nodeName+"' in the given model."))}})},on:function(e,t){this.emitter.on(e,t)},once:function(e,t){this.emitter.once(e,t)},off:function(e,t){this.emitter.off(e,t)},getResolver:function(){return this.resolver},getCurrentModel:function(){return this.currentModel},getDeployModel:function(){return this.deployModel},getLastModel:function(){return this.deployModel?this.deployModel:this.currentModel},getNodeName:function(){return this.nodeName},getLoggerFactory:function(){return this.loggerFactory}},e.exports=n},function(t,r){t.exports=e},function(e,t){function r(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function n(e){return"function"==typeof e}function o(e){return"number"==typeof e}function i(e){return"object"==typeof e&&null!==e}function s(e){return void 0===e}e.exports=r,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._maxListeners=void 0,r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(e){if(!o(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},r.prototype.emit=function(e){var t,r,o,a,u,c;if(this._events||(this._events={}),"error"===e&&(!this._events.error||i(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var l=new Error('Uncaught, unspecified "error" event. ('+t+")");throw l.context=t,l}if(r=this._events[e],s(r))return!1;if(n(r))switch(arguments.length){case 1:r.call(this);break;case 2:r.call(this,arguments[1]);break;case 3:r.call(this,arguments[1],arguments[2]);break;default:a=Array.prototype.slice.call(arguments,1),r.apply(this,a)}else if(i(r))for(a=Array.prototype.slice.call(arguments,1),c=r.slice(),o=c.length,u=0;u<o;u++)c[u].apply(this,a);return!0},r.prototype.addListener=function(e,t){var o;if(!n(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,n(t.listener)?t.listener:t),this._events[e]?i(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,i(this._events[e])&&!this._events[e].warned&&(o=s(this._maxListeners)?r.defaultMaxListeners:this._maxListeners)&&o>0&&this._events[e].length>o&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(e,t){function r(){this.removeListener(e,r),o||(o=!0,t.apply(this,arguments))}if(!n(t))throw TypeError("listener must be a function");var o=!1;return r.listener=t,this.on(e,r),this},r.prototype.removeListener=function(e,t){var r,o,s,a;if(!n(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(r=this._events[e],s=r.length,o=-1,r===t||n(r.listener)&&r.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(i(r)){for(a=s;a-- >0;)if(r[a]===t||r[a].listener&&r[a].listener===t){o=a;break}if(o<0)return this;1===r.length?(r.length=0,delete this._events[e]):r.splice(o,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},r.prototype.removeAllListeners=function(e){var t,r;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(r=this._events[e],n(r))this.removeListener(e,r);else if(r)for(;r.length;)this.removeListener(e,r[r.length-1]);return delete this._events[e],this},r.prototype.listeners=function(e){return this._events&&this._events[e]?n(this._events[e])?[this._events[e]]:this._events[e].slice():[]},r.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(n(t))return 1;if(t)return t.length}return 0},r.listenerCount=function(e,t){return e.listenerCount(t)}},function(e,t,r){"use strict";(function(t){var n=r(5);e.exports=function(e,r,o,i,s){var a=(new Date).getTime(),u=[];return n(o).reduce(function(t,r,n,o){return t.then(function(){return n>0&&u.unshift(o[n-1]),r.execute()}).catch(function(t){if(!e.stopping)throw t;e.log.error("Adaptation error while stopping core...\n"+t.stack)})},Promise.resolve()).then(function(){e.currentModel=r,e.deployModel=null,e.log.info((e.stopping?"Stop model":"Model")+" deployed successfully: "+o.length+" adaptations ("+((new Date).getTime()-a)+"ms)"),e.processScriptQueue(),e.firstBoot=!1;try{e.emitter.emit("deployed"),i()}catch(t){e.log.error("Error catched\n"+t.stack)}}).catch(function(r){r.message="Something went wrong while executing adaptations.\n"+r.message,e.log.error(r.stack),e.firstBoot?(e.log.warn("Shutting down Kevoree because bootstrap failed..."),e.deployModel=null,e.stop(),t.nextTick(function(){s(r)})):u.reduce(function(e,t){return e.then(function(){return t.undo()})},Promise.resolve()).then(function(){e.log.info("Rollback succeed: "+u.length+" adaptations ("+((new Date).getTime()-a)+"ms)"),e.deployModel=null,e.emitter.emit("rollbackSucceed"),i()}).catch(function(t){t.message="Something went wrong while rollbacking. Process will exit.\n"+t.message,e.log.error(t.stack),e.deployModel=null,e.stop(),s(t),e.emitter.emit("error",t)})})}}).call(t,r(4))},function(e,t){function r(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}function o(e){if(l===setTimeout)return setTimeout(e,0);if((l===r||!l)&&setTimeout)return l=setTimeout,setTimeout(e,0);try{return l(e,0)}catch(t){try{return l.call(null,e,0)}catch(t){return l.call(this,e,0)}}}function i(e){if(h===clearTimeout)return clearTimeout(e);if((h===n||!h)&&clearTimeout)return h=clearTimeout,clearTimeout(e);try{return h(e)}catch(t){try{return h.call(null,e)}catch(t){return h.call(this,e)}}}function s(){m&&d&&(m=!1,d.length?p=d.concat(p):v=-1,p.length&&a())}function a(){if(!m){var e=o(s);m=!0;for(var t=p.length;t;){for(d=p,p=[];++v<t;)d&&d[v].run();v=-1,t=p.length}d=null,m=!1,i(e)}}function u(e,t){this.fun=e,this.array=t}function c(){}var l,h,f=e.exports={};!function(){try{l="function"==typeof setTimeout?setTimeout:r}catch(e){l=r}try{h="function"==typeof clearTimeout?clearTimeout:n}catch(e){h=n}}();var d,p=[],m=!1,v=-1;f.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];p.push(new u(e,t)),1!==p.length||m||o(a)},u.prototype.run=function(){this.fun.apply(null,this.array)},f.title="browser",f.browser=!0,f.env={},f.argv=[],f.version="",f.versions={},f.on=c,f.addListener=c,f.once=c,f.off=c,f.removeListener=c,f.removeAllListeners=c,f.emit=c,f.prependListener=c,f.prependOnceListener=c,f.listeners=function(e){return[]},f.binding=function(e){throw new Error("process.binding is not supported")},f.cwd=function(){return"/"},f.chdir=function(e){throw new Error("process.chdir is not supported")},f.umask=function(){return 0}},function(e,t,r){"use strict";e.exports=function(e){return e.map(function(e){return{type:e.toString(),path:e.modelElement.path(),execute:function(){return new Promise(function(t,r){e.execute(function(e){e?r(e):t()})})},undo:function(){return new Promise(function(t,r){e.undo(function(e){e?r(e):t()})})}}})}}])});